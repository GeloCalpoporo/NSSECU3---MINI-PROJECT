/*
 * YARA Rules for Common Malware Detection (deepseek)
 * Author: Generated for MP1 Malware Forensics Project: deepseek
 * Date: 2026-02-13
 * Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
 */

rule SUSPICIOUS_PE_HighEntropy_Sections
{
    meta:
        author = "deepseek"
        description = "Detects PE files with high entropy sections (potential packed/encrypted malware)"
        date = "2026-02-13"
        score = 85
        fileType = "PE_EXECUTABLE"
    
    strings:
        $magic = { 4D 5A }                    // MZ header
        
    condition:
        // Magic number check first (best practice)
        uint16(0) == 0x5A4D and pe.is_pe and
        
        // Check for suspicious section characteristics
        (
            // High entropy in .text section (packed)
            (for any section in pe.sections : 
                (section.name == ".text" or section.name == "UPX0" or section.name == ".aspack") and
                section.entropy > 6.8
            ) or
            
            // Unusual section names
            (for any section in pe.sections :
                section.name == ".upx0" or
                section.name == ".aspack" or
                section.name == ".adata" or
                section.name == "PACKED"
            ) or
            
            // Suspicious section characteristics
            (for any section in pe.sections :
                section.characteristics & pe.SECTION_MEM_WRITE and
                section.characteristics & pe.SECTION_MEM_EXECUTE
            )
        ) and
        
        // Avoid false positives on legitimate software
        not pe.is_signed and
        pe.number_of_signatures == 0
}

rule SUSPICIOUS_PE_Suspicious_Imports
{
    meta:
        author = "deepseek"
        description = "Detects PE files with suspicious API imports (injection, persistence, evasion)"
        date = "2026-02-13"
        score = 80
        fileType = "PE_EXECUTABLE"
    
    strings:
        $magic = { 4D 5A }
        
    condition:
        uint16(0) == 0x5A4D and pe.is_pe and
        
        (
            // Process injection APIs
            pe.imports("kernel32.dll", "VirtualAllocEx") or
            pe.imports("kernel32.dll", "WriteProcessMemory") or
            pe.imports("kernel32.dll", "CreateRemoteThread") or
            pe.imports("ntdll.dll", "NtCreateThreadEx") or
            
            // Persistence mechanisms
            pe.imports("advapi32.dll", "CreateService") or
            pe.imports("advapi32.dll", "StartServiceCtrlDispatcher") or
            pe.imports("winreg.dll", "RegSetValueEx") or
            
            // Anti-debugging/evasion
            pe.imports("kernel32.dll", "IsDebuggerPresent") or
            pe.imports("ntdll.dll", "NtQueryInformationProcess") or
            pe.imports("kernel32.dll", "CheckRemoteDebuggerPresent")
        ) and
        
        // At least 2 suspicious imports
        #imports >= 2
}

rule MALICIOUS_PDF_JavaScript_Objects
{
    meta:
        author = "deepseek"
        description = "Detects PDF files containing JavaScript objects (potential malicious PDF)"
        date = "2026-02-13"
        score = 90
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }              // %PDF header
        $js1 = "/JavaScript" nocase
        $js2 = "/JS" nocase
        $launch = "/Launch" nocase
        $embedded = "/EmbeddedFile" nocase
        $openaction = "/OpenAction" nocase
        $uri = "/URI" nocase
        
    condition:
        // PDF magic number at beginning
        $magic at 0 and
        
        // Contains JavaScript indicators
        ($js1 or $js2) and
        
        // AND suspicious PDF features
        ($launch or $embedded or $openaction) and
        
        // PDF version is not too old (maybe false positive on ancient files)
        filesize < 10MB
}

rule MALICIOUS_PDF_Exploit_Strings
{
    meta:
        author = "deepseek"
        description = "Detects PDF files with exploit-related strings"
        date = "2026-02-13"
        score = 85
        fileType = "PDF_DOCUMENT"
    
    strings:
        $magic = { 25 50 44 46 }
        
        // Heap spray patterns
        $heapspray1 = "/UI" nocase
        $heapspray2 = "/Collab" nocase
        
        // Known vulnerable functions
        $collab = "/Collab.getIcon" nocase
        $util = "app.util" nocase
        $eval = "eval(" nocase ascii
        
        // Exploit kits
        $ek1 = "/BlackHole" nocase
        $ek2 = "/Angler" nocase
        $ek3 = "/Nuclear" nocase
        
        // Suspicious hex patterns (shellcode)
        $shellcode1 = { 68 ?? ?? ?? ?? 68 ?? ?? ?? ?? E8 ?? ?? ?? ?? } // push push call pattern
        $shellcode2 = { 31 C9 64 8B 71 30 }                            // EGG hunter pattern
        
    condition:
        $magic at 0 and
        
        (
            ($heapspray1 or $heapspray2) or
            ($collab and $util) or
            $eval or
            $ek1 or $ek2 or $ek3 or
            $shellcode1 or $shellcode2
        )
}

rule MALICIOUS_OFFICE_Macros_VBA
{
    meta:
        author = "deepseek"
        description = "Detects Office documents with VBA macros (potential malware)"
        date = "2026-02-13"
        score = 95
        fileType = "OFFICE_DOCUMENT"
    
    strings:
        // OLE2 magic number (Old Office)
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 }
        
        // Office Open XML (new Office)
        $zip_magic = { 50 4B 03 04 }
        
        // VBA indicators
        $vba1 = "VBA" nocase
        $vba2 = "Module=" nocase
        $vba3 = "ThisWorkbook" nocase
        $vba4 = "ThisDocument" nocase
        
        // Suspicious VBA functions
        $shell = "Shell(" nocase ascii
        $createobject = "CreateObject(" nocase ascii
        $wscript = "WScript.Shell" nocase ascii
        $powershell = "PowerShell" nocase ascii
        $cmd = "cmd.exe" nocase ascii
        $download = "URLDownloadToFile" nocase ascii
        $xmlhttp = "XMLHTTP" nocase ascii
        $adodb = "ADODB.Stream" nocase ascii
        
        // Auto-execute macros
        $auto_open = "Auto_Open" nocase ascii
        $auto_close = "Auto_Close" nocase ascii
        $document_open = "Document_Open" nocase ascii
        $workbook_open = "Workbook_Open" nocase ascii
        
    condition:
        // Office file detection
        ($ole_magic at 0 or $zip_magic at 0) and
        
        // VBA presence
        ($vba1 or $vba2) and
        
        // Suspicious indicators (at least one)
        (
            $shell or $createobject or $wscript or
            $powershell or $cmd or $download or
            $xmlhttp or $adodb
        ) and
        
        // AND/OR auto-execute macro
        ($auto_open or $auto_close or $document_open or $workbook_open)
}

rule MALICIOUS_JavaScript_Obfuscated
{
    meta:
        author = "deepseek"
        description = "Detects obfuscated/deobfuscation patterns in JavaScript"
        date = "2026-02-13"
        score = 85
        fileType = "JAVASCRIPT"
    
    strings:
        // Deobfuscation techniques
        $eval = "eval(" nocase ascii
        $document_write = "document.write(" nocase ascii
        $unescape = "unescape(" nocase ascii
        $decodeuri = "decodeURIComponent(" nocase ascii
        $fromcharcode = "String.fromCharCode(" nocase ascii
        $replace = ".replace(" nocase ascii
        $split = ".split(" nocase ascii
        $substring = ".substring(" nocase ascii
        
        // Long strings (encoded payloads)
        $long_hex = /[0-9a-fA-F]{40,}/
        $long_num = /[0-9]{50,}/
        
        // Suspicious keywords
        $activex = "ActiveXObject" nocase ascii
        $wscript = "WScript" nocase ascii
        $adodb = "ADODB" nocase ascii
        $xmlhttp = "XMLHttpRequest" nocase ascii
        
    condition:
        // JavaScript detection (heuristic)
        filesize < 1MB and
        
        // Obfuscation indicators
        (
            ($eval or $document_write) and
            ($unescape or $decodeuri or $fromcharcode) and
            #long_hex > 1 or #long_num > 1
        ) or
        
        // Suspicious objects with deobfuscation
        (
            ($activex or $wscript or $adodb or $xmlhttp) and
            ($eval or $unescape or $fromcharcode)
        )
}

rule MALICIOUS_PowerShell_Suspicious_Commands
{
    meta:
        author = "deepseek"
        description = "Detects suspicious PowerShell commands used by malware"
        date = "2026-02-13"
        score = 90
        fileType = "POWERSHELL_SCRIPT"
    
    strings:
        // Execution policy bypass
        $ep_bypass1 = "-ExecutionPolicy Bypass" nocase ascii
        $ep_bypass2 = "Set-ExecutionPolicy" nocase ascii
        
        // Hidden execution
        $hidden1 = "-WindowStyle Hidden" nocase ascii
        $hidden2 = "-WindowsStyle Hidden" nocase ascii
        $hidden3 = "-NoProfile" nocase ascii
        
        // Download cradle
        $download1 = "System.Net.WebClient" nocase ascii
        $download2 = "DownloadFile(" nocase ascii
        $download3 = "DownloadString(" nocase ascii
        $download4 = "Invoke-WebRequest" nocase ascii
        $download5 = "Invoke-RestMethod" nocase ascii
        
        // Base64 encoded commands
        $b64_flag1 = "-EncodedCommand" nocase ascii
        $b64_flag2 = "-enc" nocase ascii
        
        // Reflection/injection
        $reflection1 = "Add-Type" nocase ascii
        $reflection2 = "System.Reflection.AssemblyName" nocase ascii
        $reflection3 = "DefineDynamicAssembly" nocase ascii
        $reflection4 = "VirtualAlloc" nocase ascii
        
        // Obfuscation
        $backtick = "`" ascii
        $join = "-join" nocase ascii
        $replace_ops = ".Replace(" nocase ascii
        
    condition:
        // Look for suspicious PowerShell patterns
        (
            $ep_bypass1 or $ep_bypass2
        ) and (
            $hidden1 or $hidden2 or $hidden3
        ) and (
            $download1 or $download2 or $download3 or $download4 or $download5
        ) or
        
        // Base64 encoded commands
        $b64_flag1 or $b64_flag2 or
        
        // Memory injection patterns
        ($reflection1 and $reflection4) or
        
        // Obfuscation patterns
        (#backtick > 10 and $replace_ops)
}

rule MALICIOUS_Backdoor_Persistence
{
    meta:
        author = "deepseek"
        description = "Detects common backdoor persistence mechanisms"
        date = "2026-02-13"
        score = 90
        fileType = "VARIOUS"
    
    strings:
        // Registry persistence
        $reg_run1 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run2 = "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        $reg_run3 = "SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" nocase ascii
        
        // Scheduled tasks
        $schtasks1 = "schtasks" nocase ascii
        $schtasks2 = "/create" nocase ascii
        $schtasks3 = "/sc daily" nocase ascii
        $schtasks4 = "/sc onlogon" nocase ascii
        
        // Startup folder
        $startup1 = "Startup" nocase ascii
        $startup2 = "All Users\\Start Menu\\Programs\\Startup" nocase ascii
        
        // Service creation
        $service1 = "CreateService" nocase ascii
        $service2 = "sc.exe create" nocase ascii
        $service3 = "New-Service" nocase ascii
        
        // C2 communication patterns
        $c2_http = "http://" nocase ascii
        $c2_https = "https://" nocase ascii
        $c2_post = "POST" nocase ascii
        $c2_get = "GET" nocase ascii
        $c2_useragent = "User-Agent:" nocase ascii
        
        // Backdoor commands
        $cmd_shell = "cmd.exe /c" nocase ascii
        $ps_shell = "powershell.exe" nocase ascii
        $reverse_shell = "reverse shell" nocase ascii
        
    condition:
        // Registry persistence
        ($reg_run1 or $reg_run2 or $reg_run3) or
        
        // Scheduled task creation
        ($schtasks1 and $schtasks2) or
        
        // Service creation
        ($service1 or $service2 or $service3) or
        
        // C2 communication with persistence
        (($c2_http or $c2_https) and ($reg_run1 or $reg_run2 or $schtasks1))
}

rule MALICIOUS_Generic_Suspicious_Strings
{
    meta:
        author = "deepseek"
        description = "Detects generic suspicious strings commonly found in malware"
        date = "2026-02-13"
        score = 70
        fileType = "VARIOUS"
    
    strings:
        $s1 = "MALWARE" nocase ascii wide
        $s2 = "BACKDOOR" nocase ascii wide
        $s3 = "RAT" nocase ascii wide
        $s4 = "DROPPER" nocase ascii wide
        $s5 = "PAYLOAD" nocase ascii wide
        $s6 = "EXPLOIT" nocase ascii wide
        $s7 = "CRYPT" nocase ascii wide
        $s8 = "INJECT" nocase ascii wide
        $s9 = "KEYLOG" nocase ascii wide
        $s10 = "PASSWORD STEALER" nocase ascii wide
        $s11 = "BYPASS" nocase ascii wide
        $s12 = "PRIVILEGE ESCALATION" nocase ascii wide
        
    condition:
        // At least 2 suspicious strings
        2 of ($s*)
}