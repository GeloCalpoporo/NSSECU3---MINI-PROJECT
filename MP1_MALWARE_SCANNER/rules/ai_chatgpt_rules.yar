/*
 * YARA Rules for Common Malware Detection 
 * Author: Generated for MP1 Malware Forensics Project: ChatGPT GPT-5.2
 * Date: 2026-02-13
 * Description: Detects common malware patterns in PE, PDF, Office, JS, and PowerShell files
 */

import "pe"
import "math"

/* =========================================================
   1. Generic PE Malware Indicators
   ========================================================= */
rule PE_Generic_Malware_Indicators
{
    meta:
        category = "pe"
        confidence = "medium"
        description = "Detects suspicious PE characteristics such as high entropy, odd sections, and packing"
        author = "ChatGPT GPT-5.2"

    strings:
        $packer1 = "UPX!" ascii
        $packer2 = "MPRESS" ascii
        $packer3 = "Themida" ascii
        $suspicious_api1 = "VirtualAlloc" ascii
        $suspicious_api2 = "WriteProcessMemory" ascii
        $suspicious_api3 = "CreateRemoteThread" ascii

    condition:
        uint16(0) == 0x5A4D and
        pe.is_pe and
        (
            any of ($packer*) or
            (
                pe.number_of_sections > 6 and
                math.entropy(pe.sections[0].raw_data_offset, pe.sections[0].raw_data_size) > 7.0
            ) or
            all of ($suspicious_api*)
        )
}

/* =========================================================
   2. PDF with JavaScript or Embedded Objects
   ========================================================= */
rule PDF_Embedded_JavaScript
{
    meta:
        category = "pdf"
        confidence = "high"
        description = "Detects PDFs with embedded JavaScript or suspicious objects"
        author = "ChatGPT GPT-5.2"

    strings:
        $pdf_magic = "%PDF-" ascii
        $js1 = "/JavaScript" ascii
        $js2 = "/JS" ascii
        $action = "/OpenAction" ascii
        $objstm = "/ObjStm" ascii
        $stream = "stream" ascii

    condition:
        $pdf_magic at 0 and
        2 of ($js1, $js2, $action, $objstm, $stream)
}

/* =========================================================
   3. Office Documents with Macros
   ========================================================= */
rule Office_Macro_Malware
{
    meta:
        category = "office"
        confidence = "high"
        description = "Detects malicious VBA macro keywords in Office documents"
        author = "ChatGPT GPT-5.2"

    strings:
        $ole_magic = { D0 CF 11 E0 A1 B1 1A E1 }
        $autoopen1 = "AutoOpen" ascii nocase
        $autoopen2 = "Document_Open" ascii nocase
        $shell = "Shell(" ascii nocase
        $powershell = "powershell" ascii nocase
        $wscript = "WScript.Shell" ascii nocase
        $base64 = "Base64Decode" ascii nocase

    condition:
        $ole_magic at 0 and
        2 of ($autoopen*, $shell, $powershell, $wscript, $base64)
}

/* =========================================================
   4. Suspicious PowerShell Commands
   ========================================================= */
rule PowerShell_Suspicious_Commands
{
    meta:
        category = "powershell"
        confidence = "high"
        description = "Detects obfuscated or malicious PowerShell behavior"
        author = "ChatGPT GPT-5.2"

    strings:
        $ps1 = "powershell" ascii nocase
        $enc = "-enc" ascii nocase
        $bypass = "ExecutionPolicy Bypass" ascii nocase
        $iex = "Invoke-Expression" ascii nocase
        $download = "DownloadString" ascii nocase
        $hidden = "-windowstyle hidden" ascii nocase

    condition:
        $ps1 and
        2 of ($enc, $bypass, $iex, $download, $hidden)
}

/* =========================================================
   5. JavaScript Malware / Backdoor Patterns
   ========================================================= */
rule JavaScript_Malware_Backdoor
{
    meta:
        category = "javascript"
        confidence = "medium"
        description = "Detects suspicious JavaScript obfuscation and backdoor-like behavior"
        author = "ChatGPT GPT-5.2"

    strings:
        $eval = "eval(" ascii nocase
        $fromchar = "String.fromCharCode" ascii nocase
        $unescape = "unescape(" ascii nocase
        $xhr = "XMLHttpRequest" ascii nocase
        $fetch = "fetch(" ascii nocase
        $c2 = "http://" ascii nocase
        $c2s = "https://" ascii nocase

    condition:
        3 of ($eval, $fromchar, $unescape, $xhr, $fetch) and
        any of ($c2*)
}

/* =========================================================
   6. Generic Backdoor / RAT Indicators
   ========================================================= */
rule Generic_Backdoor_Patterns
{
    meta:
        category = "backdoor"
        confidence = "medium"
        description = "Detects common backdoor and RAT command patterns"
        author = "ChatGPT GPT-5.2"

    strings:
        $cmd1 = "cmd.exe /c" ascii nocase
        $cmd2 = "whoami" ascii nocase
        $cmd3 = "net user" ascii nocase
        $cmd4 = "net localgroup" ascii nocase
        $persist1 = "Run\\\\" ascii nocase
        $persist2 = "CurrentVersion\\\\Run" ascii nocase

    condition:
        2 of ($cmd*) or
        any of ($persist*)
}
